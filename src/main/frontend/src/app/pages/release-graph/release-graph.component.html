<div class="graph-container">
  @if (isLoading) {
    <app-loader />
  } @else if (this.showNotFoundError) {
    <span class="error-message">Releases not found, please try again later.</span>
  } @else {
    <svg
      #svgElement
      id="svgElement"
      [attr.viewBox]="viewBox"
      (wheel)="onWheel($event)"
      (mousedown)="onMouseDown($event)"
      (mouseup)="onMouseUp()"
      (mousemove)="onMouseMove($event)"
      (mouseleave)="onMouseUp()"
      (touchstart)="onTouchStart($event)"
      (touchmove)="onTouchMove($event)"
      (touchend)="onTouchEnd()"
      (touchcancel)="onTouchEnd()"
    >
      <g [attr.transform]="'translate(' + translateX + ',' + translateY + ') scale(' + scale + ')'">
        @for (quarter of quarterMarkers; track quarter.label) {
          <g class="quarter-marker">
            <line class="quarter-line" [attr.x1]="quarter.x" [attr.y1]="-90" [attr.x2]="quarter.x" [attr.y2]="1000" />
            <text y="-105" class="quarter-label" [attr.x]="quarter.labelX">{{ quarter.label }}</text>
          </g>
        }

        <g class="current-time-marker">
          <line
            class="current-time-line"
            [attr.x1]="currentTimeX"
            [attr.y1]="-80"
            [attr.x2]="currentTimeX"
            [attr.y2]="1000"
          />
          <path
            class="current-time-chevron"
            d="M -8 0 L 0 8 L 8 0 Z"
            [attr.transform]="'translate(' + currentTimeX + ', -90)'"
          />
        </g>

        @for (lifecycle of branchLifecycles; track lifecycle.branchLabel + '-' + lifecycle.y) {
          <g class="branch-lifecycle">
            @for (phase of lifecycle.phases; track phase.startX) {
              <rect
                class="lifecycle-phase"
                [attr.data-phase]="phase.type"
                [attr.x]="phase.startX"
                [attr.y]="lifecycle.y - 45"
                [attr.width]="phase.endX - phase.startX"
                [attr.height]="70"
                [attr.fill]="phase.color"
                [attr.stroke]="phase.stroke"
              />
            }
          </g>
        }

        @for (link of visibleLinks; track link) {
          <path
            [attr.data-cy]="'link-' + link.id"
            [attr.d]="getCustomPath(link)"
            [class.dotted]="link.isGap || link.isFadeIn"
            [class.fade-in]="link.isFadeIn"
          />
        }

        @for (releaseNode of visibleReleaseNodes; track releaseNode.id) {
          <g
            class="release-node"
            [class.mini-node]="releaseNode.isMiniNode"
            [attr.data-cy]="'node-' + releaseNode.label"
            [attr.transform]="'translate(' + releaseNode.position.x + ',' + releaseNode.position.y + ')'"
            (click)="openReleaseNodeDetails(releaseNode.id)"
            (touchend)="handleNodeTouchEnd($event, releaseNode)"
            (touchcancel)="handleNodeTouchEnd($event, releaseNode)"
          >
            @if (releaseNode.isMiniNode) {
              <circle r="6" fill="#999" />
            } @else {
              <circle r="10" [attr.fill]="releaseNode.color" />
              <text x="0" y="-20" text-anchor="middle">
                {{ releaseNode.label }}
              </text>
            }
          </g>
        }

        @for (skipNode of skipNodes; track skipNode.id) {
          <g
            class="skip-node"
            [attr.data-cy]="'skip-node-' + skipNode.id"
            [attr.transform]="'translate(' + skipNode.x + ',' + skipNode.y + ')'"
            (click)="openSkipNodeModal(skipNode.id)"
            (touchend)="onSkipNodeTouchEnd($event, skipNode.id)"
            (touchcancel)="onSkipNodeTouchEnd($event, skipNode.id)"
          >
            <circle r="15" class="skip-circle" />
            <text y="1" class="skip-text">{{ skipNode.skippedCount }}</text>
          </g>
        }
      </g>
    </svg>

    <button
      class="nightly-toggle"
      title="Toggle Nightly Releases"
      [class.active]="showNightlies"
      [ngStyle]="{
        right: authService.isAuthenticated() && authService.currentUser()?.isFrankFrameworkMember ? '16rem' : '10.5rem',
      }"
      (click)="toggleNightlies()"
    >
      <svg viewBox="0 0 24 24" class="moon-icon">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
      </svg>
      <span class="toggle-label">Show nightly</span>
    </button>

    <div class="branch-labels-sticky">
      @for (stickyLabel of stickyBranchLabels; track stickyLabel.label) {
        <div class="sticky-branch-label-container" [style.top.px]="stickyLabel.screenY - 75">
          <span class="sticky-branch-label">{{ stickyLabel.label }}</span>
          @if (isMajorVersionBranch(stickyLabel.label)) {
            <span class="lts-badge">LTS</span>
          }
        </div>
      }
    </div>

    <app-release-catalogus [showExtendedSupport]="showExtendedSupport" />

    @if (dataForSkipModal) {
      <app-skipped-versions-modal
        [skipNode]="dataForSkipModal"
        [releases]="releases"
        (closed)="closeSkipNodeModal()"
        (versionClicked)="onSkippedVersionClick($event)"
      />
    }
  }
</div>
