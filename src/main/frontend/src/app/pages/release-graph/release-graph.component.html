<div class="graph-container">
  @if (isLoading) {
    <app-loader />
  } @else if (this.showNotFoundError) {
    <span class="error-message">Releases not found, please try again later.</span>
  } @else {
    <svg
      #svgElement
      id="svgElement"
      [attr.viewBox]="viewBox"
      (wheel)="onWheel($event)"
      (mousedown)="onMouseDown($event)"
      (mouseup)="onMouseUp()"
      (mousemove)="onMouseMove($event)"
      (mouseleave)="onMouseUp()"
      (touchstart)="onTouchStart($event)"
      (touchmove)="onTouchMove($event)"
      (touchend)="onTouchEnd()"
      (touchcancel)="onTouchEnd()"
    >
      <g [attr.transform]="'translate(' + translateX + ',' + translateY + ') scale(' + scale + ')'">
        @for (quarter of quarterMarkers; track quarter.label) {
          <g class="quarter-marker">
            <line class="quarter-line" [attr.x1]="quarter.x" [attr.y1]="-90" [attr.x2]="quarter.x" [attr.y2]="1000" />
            <text y="-100" class="quarter-label" [attr.x]="quarter.labelX">{{ quarter.label }}</text>
          </g>
        }

        <g class="current-time-marker">
          <line
            class="current-time-line"
            [attr.x1]="currentTimeX"
            [attr.y1]="-80"
            [attr.x2]="currentTimeX"
            [attr.y2]="1000"
          />
          <path
            class="current-time-chevron"
            d="M -8 0 L 0 8 L 8 0 Z"
            [attr.transform]="'translate(' + currentTimeX + ', -90)'"
          />
        </g>

        @for (lifecycle of branchLifecycles; track lifecycle.branchLabel + '-' + lifecycle.y) {
          <g class="branch-lifecycle">
            @for (phase of lifecycle.phases; track phase.startX) {
              <rect
                class="lifecycle-phase"
                [attr.data-phase]="phase.type"
                [attr.x]="phase.startX"
                [attr.y]="lifecycle.y - 45"
                [attr.width]="phase.endX - phase.startX"
                [attr.height]="70"
                [attr.fill]="phase.color"
              />
            }
          </g>
        }

        @for (link of allLinks; track link) {
          <path
            [attr.data-cy]="'link-' + link.id"
            [attr.d]="getCustomPath(link)"
            [class.dotted]="link.isGap || link.isFadeIn"
            [class.fade-in]="link.isFadeIn"
          />
        }

        @for (entry of expandedClustersArray; track entry.key) {
          @if (entry.value.clusteredNodes && entry.value.clusteredNodes.length > 0) {
            @let lastNodePos = getLastExpandedNodePosition(entry.value);
            @if (lastNodePos) {
              <g
                class="collapse-button visible"
                [attr.transform]="'translate(' + (lastNodePos.x + 45) + ',' + lastNodePos.y + ')'"
                (click)="collapseCluster(entry.key)"
                (touchend)="onCollapseButtonTouchEnd($event, entry.key)"
                (touchcancel)="onCollapseButtonTouchEnd($event, entry.key)"
              >
                <rect class="collapse-bg" x="0" y="-10" width="50" height="20" rx="4" />
                <text class="collapse-icon" x="25" y="0">Collapse</text>
              </g>
            }
          }
        }

        @for (releaseNode of releaseNodes; track releaseNode.id) {
          <g
            class="release-node"
            [class.cluster-node]="releaseNode.isCluster"
            [attr.data-cy]="'node-' + releaseNode.label"
            [attr.transform]="'translate(' + releaseNode.position.x + ',' + releaseNode.position.y + ')'"
            (click)="releaseNode.isCluster ? toggleCluster(releaseNode) : openReleaseNodeDetails(releaseNode.id)"
            (touchend)="handleNodeTouchEnd($event, releaseNode)"
            (touchcancel)="handleNodeTouchEnd($event, releaseNode)"
          >
            @if (releaseNode.isCluster) {
              <circle r="20" fill="#e9ecef" class="cluster-circle-back" cx="2" cy="2" opacity="0.3" />
              <circle r="20" fill="#f1f3f5" class="cluster-circle-mid" cx="1" cy="1" opacity="0.5" />
              <circle r="20" fill="#ffffff" stroke="#ced4da" stroke-width="5" />
              <path d="M -6 -6 L -1 0 L -6 6 M 1 -6 L 6 0 L 1 6" class="cluster-icon" />
              <text y="-30" class="cluster-label">{{ releaseNode.clusteredNodes!.length }} releases</text>
            } @else {
              <circle r="20" [attr.fill]="releaseNode.color" />
              <text y="-30">
                {{ releaseNode.label }}
              </text>
            }
          </g>
        }

        @for (skipNode of skipNodes; track skipNode.id) {
          <g
            class="skip-node"
            [attr.data-cy]="'skip-node-' + skipNode.id"
            [attr.transform]="'translate(' + skipNode.x + ',' + skipNode.y + ')'"
            (click)="openSkipNodeModal(skipNode.id)"
            (touchend)="onSkipNodeTouchEnd($event, skipNode.id)"
            (touchcancel)="onSkipNodeTouchEnd($event, skipNode.id)"
          >
            <circle r="20" class="skip-circle" />
            <text y="2" class="skip-text">{{ skipNode.skippedCount }}</text>
          </g>
        }
      </g>
    </svg>

    <div class="branch-labels-sticky">
      @for (stickyLabel of stickyBranchLabels; track stickyLabel.label) {
        <div class="sticky-branch-label-container" [style.top.px]="stickyLabel.screenY - 75">
          <span class="sticky-branch-label">{{ stickyLabel.label }}</span>
          @if (stickyLabel.supportStatus === 'supported') {
            <span class="support-status-dot"></span>
          }
        </div>
      }
    </div>

    <app-release-catalogus />

    @if (dataForSkipModal) {
      <app-skipped-versions-modal
        [skipNode]="dataForSkipModal"
        [releases]="releases"
        (closed)="closeSkipNodeModal()"
        (versionClicked)="onSkippedVersionClick($event)"
      />
    }
  }
</div>
