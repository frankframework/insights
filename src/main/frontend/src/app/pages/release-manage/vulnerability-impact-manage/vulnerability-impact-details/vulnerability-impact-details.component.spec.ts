import { ComponentFixture, TestBed } from '@angular/core/testing';
import { ReactiveFormsModule } from '@angular/forms';
import { VulnerabilityImpactDetailsComponent } from './vulnerability-impact-details.component';
import { Vulnerability, VulnerabilitySeverities } from '../../../../services/vulnerability.service';
import { ComponentRef } from '@angular/core';

describe('VulnerabilityImpactDetailsComponent', () => {
  let component: VulnerabilityImpactDetailsComponent;
  let fixture: ComponentFixture<VulnerabilityImpactDetailsComponent>;
  let componentReference: ComponentRef<VulnerabilityImpactDetailsComponent>;

  const mockVulnerabilityWithImpact: Vulnerability = {
    cveId: 'CVE-2024-0001',
    severity: VulnerabilitySeverities.CRITICAL,
    cvssScore: 9.8,
    description: 'Critical vulnerability',
    cwes: ['CWE-78'],
    impactScore: 8.5,
    impactDescription: 'High impact'
  };

  const mockVulnerabilityWithoutImpact: Vulnerability = {
    cveId: 'CVE-2024-0002',
    severity: VulnerabilitySeverities.HIGH,
    cvssScore: 8.5,
    description: 'High severity vulnerability',
    cwes: ['CWE-79'],
    impactScore: null,
    impactDescription: null
  };

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [VulnerabilityImpactDetailsComponent, ReactiveFormsModule]
    }).compileComponents();

    fixture = TestBed.createComponent(VulnerabilityImpactDetailsComponent);
    component = fixture.componentInstance;
    componentReference = fixture.componentRef;
    componentReference.setInput('vulnerability', null);
    componentReference.setInput('isSaving', false);
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should initialize form on init', () => {
    expect(component.impactForm).toBeDefined();
    expect(component.impactForm.get('impactScore')).toBeDefined();
    expect(component.impactForm.get('impactDescription')).toBeDefined();
  });

  it('should populate form when vulnerability with impact is provided', () => {
    componentReference.setInput('vulnerability', mockVulnerabilityWithImpact);
    fixture.detectChanges();

    expect(component.impactForm.get('impactScore')?.value).toBe(8.5);
    expect(component.impactForm.get('impactDescription')?.value).toBe('High impact');
  });

  it('should populate form with empty values when vulnerability without impact is provided', () => {
    componentReference.setInput('vulnerability', mockVulnerabilityWithoutImpact);
    fixture.detectChanges();

    expect(component.impactForm.get('impactScore')?.value).toBeNull();
    expect(component.impactForm.get('impactDescription')?.value).toBe('');
  });

  it('should reset form when vulnerability becomes null', () => {
    componentReference.setInput('vulnerability', mockVulnerabilityWithImpact);
    fixture.detectChanges();

    componentReference.setInput('vulnerability', null);
    fixture.detectChanges();

    expect(component.impactForm.get('impactScore')?.value).toBeNull();
    expect(component.impactForm.get('impactDescription')?.value).toBeNull();
  });

  it('should detect form changes', () => {
    componentReference.setInput('vulnerability', mockVulnerabilityWithImpact);
    fixture.detectChanges();

    expect(component.isFormChanged()).toBe(false);

    component.impactForm.patchValue({ impactScore: 9 });

    expect(component.isFormChanged()).toBe(true);
  });

  it('should validate impact score range', () => {
    const impactScoreControl = component.impactForm.get('impactScore');

    impactScoreControl?.setValue(-1);

    expect(impactScoreControl?.hasError('min')).toBe(true);

    impactScoreControl?.setValue(11);

    expect(impactScoreControl?.hasError('max')).toBe(true);

    impactScoreControl?.setValue(5);

    expect(impactScoreControl?.valid).toBe(true);
  });

  it('should validate impact description length', () => {
    const impactDescriptionControl = component.impactForm.get('impactDescription');

    impactDescriptionControl?.setValue('');
    impactDescriptionControl?.markAsTouched();

    expect(impactDescriptionControl?.hasError('required')).toBe(true);

    impactDescriptionControl?.setValue('a'.repeat(1001));

    expect(impactDescriptionControl?.hasError('maxlength')).toBe(true);

    impactDescriptionControl?.setValue('Valid description');

    expect(impactDescriptionControl?.valid).toBe(true);
  });

  it('should emit impactSaved event when save is called', () => {
    const emitSpy = spyOn(component.impactSaved, 'emit');

    componentReference.setInput('vulnerability', mockVulnerabilityWithoutImpact);
    fixture.detectChanges();

    component.impactForm.patchValue({
      impactScore: 7,
      impactDescription: 'New impact description'
    });

    component.saveImpact();

    expect(emitSpy).toHaveBeenCalledWith({
      impactScore: 7,
      impactDescription: 'New impact description'
    });
  });

  it('should not emit impactSaved when form is invalid', () => {
    const emitSpy = spyOn(component.impactSaved, 'emit');

    componentReference.setInput('vulnerability', mockVulnerabilityWithoutImpact);
    fixture.detectChanges();

    component.impactForm.patchValue({
      impactScore: null,
      impactDescription: ''
    });

    component.saveImpact();

    expect(emitSpy).not.toHaveBeenCalled();
  });

  it('should emit impactDeleted event when delete is called', () => {
    const emitSpy = spyOn(component.impactDeleted, 'emit');

    component.deleteImpact();

    expect(emitSpy).toHaveBeenCalledWith();
  });

  it('should correctly identify vulnerability has impact', () => {
    componentReference.setInput('vulnerability', mockVulnerabilityWithImpact);
    fixture.detectChanges();

    expect(component.hasImpact()).toBe(true);

    componentReference.setInput('vulnerability', mockVulnerabilityWithoutImpact);
    fixture.detectChanges();

    expect(component.hasImpact()).toBe(false);
  });

  it('should handle vulnerability change from one to another', () => {
    componentReference.setInput('vulnerability', mockVulnerabilityWithImpact);
    fixture.detectChanges();

    expect(component.impactForm.get('impactScore')?.value).toBe(8.5);

    componentReference.setInput('vulnerability', mockVulnerabilityWithoutImpact);
    fixture.detectChanges();

    expect(component.impactForm.get('impactScore')?.value).toBeNull();
  });
});
