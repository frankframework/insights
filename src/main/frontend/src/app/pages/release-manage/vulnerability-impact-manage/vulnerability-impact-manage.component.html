<div class="vulnerability-manage-container">
  @if (!isLoading()) {
    <div class="header">
      <button class="back-button" (click)="goBack()">
        <img src="assets/icons/chevron-left.svg" alt="" width="20" height="20" />
        Back to Overview
      </button>

      <div class="header-titles">
        <h2>Manage Vulnerability Impact</h2>
      </div>
    </div>

    <div class="content">
      <div class="left-panel">
        <div class="panel-header">
          <h2>Vulnerabilities</h2>
          <span class="count">{{ filteredVulnerabilities().length }}</span>
        </div>

        <div class="search-section">
          <div class="search-input-wrapper">
            <svg
              class="search-icon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <input
              type="text"
              class="search-input"
              placeholder="Search vulnerabilities..."
              [value]="vulnerabilitySearchQuery()"
              (input)="updateVulnerabilitySearchQuery($event)"
            />
          </div>
        </div>

        <div class="vulnerabilities-list">
          @if (filteredVulnerabilities().length === 0) {
            <div class="empty-state">
              <p>No vulnerabilities found.</p>
            </div>
          } @else {
            @for (vulnerability of filteredVulnerabilities(); track vulnerability.cveId) {
              <div
                class="vulnerability-item"
                [class.selected]="selectedVulnerability()?.cveId === vulnerability.cveId"
                [class.expanded]="isExpanded(vulnerability.cveId)"
              >
                <div class="item-header">
                  <div
                    class="item-clickable"
                    role="button"
                    tabindex="0"
                    (click)="selectVulnerability(vulnerability)"
                    (keydown.enter)="selectVulnerability(vulnerability)"
                    (keydown.space)="selectVulnerability(vulnerability)"
                  >
                    <div class="item-header-row">
                      <h3>{{ vulnerability.cveId }}</h3>
                      <span class="severity-badge" [ngClass]="getSeverityClass(vulnerability.severity)">
                        {{ vulnerability.severity }}
                      </span>
                    </div>

                    <div class="item-meta">
                      <span class="cvss-score">CVSS: {{ vulnerability.cvssScore }}</span>
                      @if (vulnerability.impactScore !== undefined && vulnerability.impactScore !== null) {
                        <span class="has-impact-indicator">Impact: {{ vulnerability.impactScore }}/10</span>
                      }
                    </div>
                  </div>

                  <button
                    class="expand-button"
                    title="Show description"
                    [attr.aria-expanded]="isExpanded(vulnerability.cveId)"
                    [attr.aria-label]="isExpanded(vulnerability.cveId) ? 'Collapse' : 'Expand'"
                    (click)="toggleExpanded($event, vulnerability.cveId)"
                  >
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      @if (isExpanded(vulnerability.cveId)) {
                        <polyline points="18 15 12 9 6 15" />
                      } @else {
                        <polyline points="6 9 12 15 18 9" />
                      }
                    </svg>
                  </button>
                </div>

                @if (isExpanded(vulnerability.cveId)) {
                  <div class="item-description">
                    @if (vulnerability.description) {
                      <div class="description-content" [innerHTML]="getMarkdownHtml(vulnerability.description)"></div>
                    } @else {
                      <p class="no-description">No description available</p>
                    }

                    @if (vulnerability.cwes && vulnerability.cwes.length > 0) {
                      <div class="cwes-section">
                        <h5>CWEs</h5>
                        <div class="cwe-list">
                          @for (cwe of vulnerability.cwes; track cwe) {
                            <a target="_blank" rel="noopener noreferrer" class="cwe-badge" [href]="getCweUrl(cwe)">
                              {{ cwe }}
                            </a>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>

      <div class="right-panel">
        @if (selectedVulnerability()) {
          <div class="panel-header">
            <h2>Impact Details</h2>
            @if (hasImpact()) {
              <button class="delete-button" title="Delete Impact" [disabled]="isSaving()" (click)="deleteImpact()">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-trash-fill"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"
                  />
                </svg>
              </button>
            }
          </div>

          <div class="impact-form-container">
            <form [formGroup]="impactForm" (ngSubmit)="saveImpact()">
              <div class="form-group">
                <label for="impactScore">Impact Score (0-10)</label>
                <input
                  type="number"
                  id="impactScore"
                  class="form-control"
                  formControlName="impactScore"
                  min="0"
                  max="10"
                  step="0.1"
                  placeholder="Enter impact score"
                />
                @if (impactForm.get('impactScore')?.invalid && impactForm.get('impactScore')?.touched) {
                  <div class="error-message">
                    @if (impactForm.get('impactScore')?.errors?.['required']) {
                      <span>Impact score is required</span>
                    }
                    @if (
                      impactForm.get('impactScore')?.errors?.['min'] || impactForm.get('impactScore')?.errors?.['max']
                    ) {
                      <span>Impact score must be between 0 and 10</span>
                    }
                  </div>
                }
              </div>

              <div class="form-group">
                <label for="impactDescription">Impact Description</label>
                <textarea
                  id="impactDescription"
                  class="form-control"
                  formControlName="impactDescription"
                  rows="6"
                  placeholder="Enter impact description (1-1000 characters)"
                ></textarea>
                <div class="character-count">{{ impactForm.get('impactDescription')?.value?.length || 0 }} / 1000</div>
                @if (impactForm.get('impactDescription')?.invalid && impactForm.get('impactDescription')?.touched) {
                  <div class="error-message">
                    @if (impactForm.get('impactDescription')?.errors?.['required']) {
                      <span>Impact description is required</span>
                    }
                    @if (impactForm.get('impactDescription')?.errors?.['minlength']) {
                      <span>Impact description must be at least 1 character</span>
                    }
                    @if (impactForm.get('impactDescription')?.errors?.['maxlength']) {
                      <span>Impact description cannot exceed 1000 characters</span>
                    }
                  </div>
                }
              </div>

              <button
                type="submit"
                class="save-button"
                [disabled]="impactForm.invalid || isSaving() || !isFormChanged()"
              >
                @if (isSaving()) {
                  @if (hasImpact()) {
                    <span>Updating...</span>
                  } @else {
                    <span>Adding...</span>
                  }
                } @else {
                  @if (hasImpact()) {
                    <span>Update Impact</span>
                  } @else {
                    <span>Add Impact</span>
                  }
                }
              </button>
            </form>
          </div>
        } @else {
          <div class="no-selection">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            <h3>Select a Vulnerability</h3>
            <p>Choose a vulnerability from the left panel to manage its impact details.</p>
          </div>
        }
      </div>
    </div>
  } @else {
    <app-loader />
  }
</div>
