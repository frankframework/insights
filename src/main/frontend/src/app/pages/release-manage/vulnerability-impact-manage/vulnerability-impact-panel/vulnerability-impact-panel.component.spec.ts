import { ComponentFixture, TestBed } from '@angular/core/testing';
import { VulnerabilityImpactPanelComponent } from './vulnerability-impact-panel.component';
import { Vulnerability, VulnerabilitySeverities } from '../../../../services/vulnerability.service';
import { ComponentRef } from '@angular/core';

function createInputEvent(value: string): Event {
  return { target: { value } } as any;
}

describe('VulnerabilityImpactPanelComponent', () => {
  let component: VulnerabilityImpactPanelComponent;
  let fixture: ComponentFixture<VulnerabilityImpactPanelComponent>;
  let componentReference: ComponentRef<VulnerabilityImpactPanelComponent>;

  const mockVulnerabilities: Vulnerability[] = [
    {
      cveId: 'CVE-2024-0001',
      severity: VulnerabilitySeverities.CRITICAL,
      cvssScore: 9.8,
      description: 'Critical vulnerability',
      cwes: ['CWE-78'],
      impactScore: 8.5,
      impactDescription: 'High impact'
    },
    {
      cveId: 'CVE-2024-0002',
      severity: VulnerabilitySeverities.HIGH,
      cvssScore: 8.5,
      description: 'High severity vulnerability',
      cwes: ['CWE-79'],
      impactScore: null,
      impactDescription: null
    },
    {
      cveId: 'CVE-2024-0003',
      severity: VulnerabilitySeverities.MEDIUM,
      cvssScore: 5.5,
      description: 'Medium severity vulnerability',
      cwes: ['CWE-89'],
      impactScore: null,
      impactDescription: null
    }
  ];

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [VulnerabilityImpactPanelComponent]
    }).compileComponents();

    fixture = TestBed.createComponent(VulnerabilityImpactPanelComponent);
    component = fixture.componentInstance;
    componentReference = fixture.componentRef;
    componentReference.setInput('vulnerabilities', mockVulnerabilities);
    componentReference.setInput('selectedVulnerabilityId', null);
    componentReference.setInput('searchQuery', '');
    fixture.detectChanges();
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should display all vulnerabilities', () => {
    expect(component.filteredVulnerabilities().length).toBe(3);
  });

  it('should sort vulnerabilities by severity and CVSS score', () => {
    const sorted = component.filteredVulnerabilities();

    expect(sorted[0].severity).toBe(VulnerabilitySeverities.CRITICAL);
    expect(sorted[1].severity).toBe(VulnerabilitySeverities.HIGH);
    expect(sorted[2].severity).toBe(VulnerabilitySeverities.MEDIUM);
  });

  it('should filter vulnerabilities by search query', () => {
    componentReference.setInput('searchQuery', 'CVE-2024-0001');
    fixture.detectChanges();

    const filtered = component.filteredVulnerabilities();

    expect(filtered.length).toBe(1);
    expect(filtered[0].cveId).toBe('CVE-2024-0001');
  });

  it('should filter vulnerabilities by description', () => {
    componentReference.setInput('searchQuery', 'critical');
    fixture.detectChanges();

    const filtered = component.filteredVulnerabilities();

    expect(filtered.length).toBe(1);
    expect(filtered[0].cveId).toBe('CVE-2024-0001');
  });

  it('should emit vulnerability selected event', () => {
    const emitSpy = spyOn(component.vulnerabilitySelected, 'emit');

    component.selectVulnerability(mockVulnerabilities[0]);

    expect(emitSpy).toHaveBeenCalledWith(mockVulnerabilities[0]);
  });

  it('should emit search query changed event', () => {
    const emitSpy = spyOn(component.searchQueryChanged, 'emit');

    component.updateSearchQuery(createInputEvent('test query'));

    expect(emitSpy).toHaveBeenCalledWith('test query');
  });

  it('should toggle expanded state', () => {
    const event = new Event('click');

    expect(component.isExpanded('CVE-2024-0001')).toBe(false);

    component.toggleExpanded(event, 'CVE-2024-0001');

    expect(component.isExpanded('CVE-2024-0001')).toBe(true);

    component.toggleExpanded(event, 'CVE-2024-0001');

    expect(component.isExpanded('CVE-2024-0001')).toBe(false);
  });

  it('should mark vulnerability as selected', () => {
    componentReference.setInput('selectedVulnerabilityId', 'CVE-2024-0001');
    fixture.detectChanges();

    expect(component.isSelected('CVE-2024-0001')).toBe(true);
    expect(component.isSelected('CVE-2024-0002')).toBe(false);
  });

  it('should return correct severity class', () => {
    expect(component.getSeverityClass('CRITICAL')).toBe('severity-critical');
    expect(component.getSeverityClass('HIGH')).toBe('severity-high');
  });

  it('should return correct CWE URL', () => {
    const url = component.getCweUrl('CWE-79');

    expect(url).toBe('https://cwe.mitre.org/data/definitions/79.html');
  });

  it('should return correct markdown HTML', () => {
    const markdown = '# Test Heading\n\nThis is a paragraph with a [link](https://example.com).';
    const html = component.getMarkdownHtml(markdown);

    expect(html).toBeTruthy();
  });

  it('should handle empty search query', () => {
    componentReference.setInput('searchQuery', '   ');
    fixture.detectChanges();

    const filtered = component.filteredVulnerabilities();

    expect(filtered.length).toBe(3);
  });
});
