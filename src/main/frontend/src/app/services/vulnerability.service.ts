import { Injectable, inject } from '@angular/core';
import { Observable } from 'rxjs';
import { AppService } from '../app.service';
import { HttpClient } from '@angular/common/http';

export const VulnerabilitySeverities = {
  CRITICAL: 'CRITICAL',
  HIGH: 'HIGH',
  MEDIUM: 'MEDIUM',
  LOW: 'LOW',
  NONE: 'NONE',
  UNKNOWN: 'UNKNOWN',
} as const;

export type VulnerabilitySeverity = (typeof VulnerabilitySeverities)[keyof typeof VulnerabilitySeverities];

export interface VulnerabilityImpact {
  impactScore: number;
  impactDescription: string;
}

export interface Vulnerability {
  cveId: string;
  severity: VulnerabilitySeverity;
  cvssScore: number;
  description: string;
  cwes: string[];
  impactScore?: number | null;
  impactDescription?: string | null;
}

@Injectable({
  providedIn: 'root',
})
export class VulnerabilityService {
  private readonly http: HttpClient = inject(HttpClient);
  private readonly appService: AppService = inject(AppService);

  getVulnerabilitiesByReleaseId(releaseId: string): Observable<Vulnerability[]> {
    return this.http.get<Vulnerability[]>(this.appService.createAPIUrl(`vulnerabilities/release/${releaseId}`));
  }

  getAllVulnerabilities(): Observable<Vulnerability[]> {
    return this.http.get<Vulnerability[]>(this.appService.createAPIUrl('vulnerabilities'));
  }

  updateVulnerabilityImpact(cveId: string, impact: VulnerabilityImpact): Observable<Vulnerability> {
    return this.http.put<Vulnerability>(this.appService.createAPIUrl(`vulnerabilities/${cveId}/impact`), impact);
  }

  deleteVulnerabilityImpact(cveId: string): Observable<void> {
    return this.http.delete<void>(this.appService.createAPIUrl(`vulnerabilities/${cveId}/impact`));
  }
}
