package org.frankframework.insights.vulnerability;

import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.Collections;
import java.util.Set;
import org.frankframework.insights.common.configuration.TestSecurityConfig;
import org.frankframework.insights.common.enums.VulnerabilitySeverity;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientAutoConfiguration;
import org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.context.TestConfiguration;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Import;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;

@WebMvcTest(
        controllers = VulnerabilityController.class,
        excludeAutoConfiguration = {SecurityAutoConfiguration.class, OAuth2ClientAutoConfiguration.class})
@Import(TestSecurityConfig.class)
public class VulnerabilityControllerTest {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private VulnerabilityService vulnerabilityService;

    @Autowired
    private ObjectMapper objectMapper;

    @TestConfiguration
    public static class TestConfig {
        @Bean
        public VulnerabilityService vulnerabilityService() {
            return mock(VulnerabilityService.class);
        }
    }

    @BeforeEach
    public void resetMocks() {
        reset(vulnerabilityService);
    }

    @Test
    public void getVulnerabilitiesByReleaseId_returnsOkWithVulnerabilities() throws Exception {
        String releaseId = "release-123";
        VulnerabilityResponse vuln1 = new VulnerabilityResponse(
                "CVE-2023-1234",
                VulnerabilitySeverity.HIGH,
                VulnerabilitySeverity.HIGH.getRepresentativeScore(),
                "SQL Injection vulnerability",
                Set.of("CWE-89"),
                null,
                null);
        VulnerabilityResponse vuln2 = new VulnerabilityResponse(
                "CVE-2023-5678",
                VulnerabilitySeverity.CRITICAL,
                VulnerabilitySeverity.CRITICAL.getRepresentativeScore(),
                "Remote Code Execution",
                Set.of("CWE-78", "CWE-502"),
                null,
                null);
        Set<VulnerabilityResponse> vulnerabilities = Set.of(vuln1, vuln2);

        when(vulnerabilityService.getVulnerabilitiesByReleaseId(releaseId)).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities/release/{releaseId}", releaseId))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(2));

        verify(vulnerabilityService, times(1)).getVulnerabilitiesByReleaseId(releaseId);
    }

    @Test
    public void getVulnerabilitiesByReleaseId_returnsEmptySet() throws Exception {
        String releaseId = "release-no-vulns";
        when(vulnerabilityService.getVulnerabilitiesByReleaseId(releaseId)).thenReturn(Collections.emptySet());

        mockMvc.perform(get("/api/vulnerabilities/release/{releaseId}", releaseId))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(0));

        verify(vulnerabilityService, times(1)).getVulnerabilitiesByReleaseId(releaseId);
    }

    @Test
    public void getVulnerabilitiesByReleaseId_withSingleVulnerability() throws Exception {
        String releaseId = "release-single";
        VulnerabilityResponse vuln = new VulnerabilityResponse(
                "CVE-2024-0001",
                VulnerabilitySeverity.MEDIUM,
                VulnerabilitySeverity.MEDIUM.getRepresentativeScore(),
                "Information Disclosure",
                Set.of("CWE-200"),
                null,
                null);
        Set<VulnerabilityResponse> vulnerabilities = Set.of(vuln);

        when(vulnerabilityService.getVulnerabilitiesByReleaseId(releaseId)).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities/release/{releaseId}", releaseId))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].cveId").value("CVE-2024-0001"))
                .andExpect(jsonPath("$[0].severity").value("MEDIUM"))
                .andExpect(jsonPath("$[0].cvssScore").value(VulnerabilitySeverity.MEDIUM.getRepresentativeScore()))
                .andExpect(jsonPath("$[0].description").value("Information Disclosure"));

        verify(vulnerabilityService, times(1)).getVulnerabilitiesByReleaseId(releaseId);
    }

    @Test
    public void getVulnerabilitiesByReleaseId_withoutReleaseIdParam_returnsNotFound() throws Exception {
        mockMvc.perform(get("/api/vulnerabilities/release/")).andExpect(status().isNotFound());

        verify(vulnerabilityService, never()).getVulnerabilitiesByReleaseId(any());
    }

    @Test
    public void getVulnerabilitiesByReleaseId_withVulnerabilitiesOfDifferentSeverities() throws Exception {
        String releaseId = "release-mixed-severity";
        VulnerabilityResponse low = new VulnerabilityResponse(
                "CVE-2024-0010",
                VulnerabilitySeverity.LOW,
                VulnerabilitySeverity.LOW.getRepresentativeScore(),
                "Low severity issue",
                Set.of("CWE-1"),
                null,
                null);
        VulnerabilityResponse medium = new VulnerabilityResponse(
                "CVE-2024-0020",
                VulnerabilitySeverity.MEDIUM,
                VulnerabilitySeverity.MEDIUM.getRepresentativeScore(),
                "Medium severity issue",
                Set.of("CWE-2"),
                null,
                null);
        VulnerabilityResponse high = new VulnerabilityResponse(
                "CVE-2024-0030",
                VulnerabilitySeverity.HIGH,
                VulnerabilitySeverity.HIGH.getRepresentativeScore(),
                "High severity issue",
                Set.of("CWE-3"),
                null,
                null);
        VulnerabilityResponse critical = new VulnerabilityResponse(
                "CVE-2024-0040",
                VulnerabilitySeverity.CRITICAL,
                VulnerabilitySeverity.CRITICAL.getRepresentativeScore(),
                "Critical severity issue",
                Set.of("CWE-4"),
                null,
                null);
        Set<VulnerabilityResponse> vulnerabilities = Set.of(low, medium, high, critical);

        when(vulnerabilityService.getVulnerabilitiesByReleaseId(releaseId)).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities/release/{releaseId}", releaseId))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(4));

        verify(vulnerabilityService, times(1)).getVulnerabilitiesByReleaseId(releaseId);
    }

    @Test
    public void getVulnerabilitiesByReleaseId_withVulnerabilityWithMultipleCwes() throws Exception {
        String releaseId = "release-multi-cwe";
        VulnerabilityResponse vuln = new VulnerabilityResponse(
                "CVE-2024-9999",
                VulnerabilitySeverity.HIGH,
                VulnerabilitySeverity.HIGH.getRepresentativeScore(),
                "Multiple weakness types",
                Set.of("CWE-79", "CWE-89", "CWE-352", "CWE-434"),
                null,
                null);
        Set<VulnerabilityResponse> vulnerabilities = Set.of(vuln);

        when(vulnerabilityService.getVulnerabilitiesByReleaseId(releaseId)).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities/release/{releaseId}", releaseId))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].cwes").isArray())
                .andExpect(jsonPath("$[0].cwes.length()").value(4));

        verify(vulnerabilityService, times(1)).getVulnerabilitiesByReleaseId(releaseId);
    }

    @Test
    public void getVulnerabilitiesByReleaseId_withVulnerabilityWithNoCwes() throws Exception {
        String releaseId = "release-no-cwe";
        VulnerabilityResponse vuln = new VulnerabilityResponse(
                "CVE-2024-1111",
                VulnerabilitySeverity.LOW,
                VulnerabilitySeverity.LOW.getRepresentativeScore(),
                "Vulnerability without CWE classification",
                Collections.emptySet(),
                null,
                null);
        Set<VulnerabilityResponse> vulnerabilities = Set.of(vuln);

        when(vulnerabilityService.getVulnerabilitiesByReleaseId(releaseId)).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities/release/{releaseId}", releaseId))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].cwes").isArray())
                .andExpect(jsonPath("$[0].cwes.length()").value(0));

        verify(vulnerabilityService, times(1)).getVulnerabilitiesByReleaseId(releaseId);
    }

    @Test
    public void getAllVulnerabilities_returnsOkWithVulnerabilities() throws Exception {
        VulnerabilityResponse vuln1 = new VulnerabilityResponse(
                "CVE-2023-1234",
                VulnerabilitySeverity.HIGH,
                7.5,
                "SQL Injection vulnerability",
                Set.of("CWE-89"),
                8.0,
                "High impact on production");
        VulnerabilityResponse vuln2 = new VulnerabilityResponse(
                "CVE-2023-5678",
                VulnerabilitySeverity.CRITICAL,
                9.8,
                "Remote Code Execution",
                Set.of("CWE-78", "CWE-502"),
                9.5,
                "Critical impact");
        Set<VulnerabilityResponse> vulnerabilities = Set.of(vuln1, vuln2);

        when(vulnerabilityService.getAllVulnerabilities()).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities"))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(2));

        verify(vulnerabilityService, times(1)).getAllVulnerabilities();
    }

    @Test
    public void getAllVulnerabilities_returnsEmptyList() throws Exception {
        when(vulnerabilityService.getAllVulnerabilities()).thenReturn(Collections.emptySet());

        mockMvc.perform(get("/api/vulnerabilities"))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(0));

        verify(vulnerabilityService, times(1)).getAllVulnerabilities();
    }

    @Test
    public void getAllVulnerabilities_withImpactScores() throws Exception {
        VulnerabilityResponse vuln = new VulnerabilityResponse(
                "CVE-2024-0001",
                VulnerabilitySeverity.MEDIUM,
                5.5,
                "Information Disclosure",
                Set.of("CWE-200"),
                7.0,
                "Medium impact on business operations");
        Set<VulnerabilityResponse> vulnerabilities = Set.of(vuln);

        when(vulnerabilityService.getAllVulnerabilities()).thenReturn(vulnerabilities);

        mockMvc.perform(get("/api/vulnerabilities"))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$").isArray())
                .andExpect(jsonPath("$.length()").value(1))
                .andExpect(jsonPath("$[0].cveId").value("CVE-2024-0001"))
                .andExpect(jsonPath("$[0].impactScore").value(7.0))
                .andExpect(jsonPath("$[0].impactDescription").value("Medium impact on business operations"));

        verify(vulnerabilityService, times(1)).getAllVulnerabilities();
    }

    @Test
    public void updateVulnerability_returnsOkWithUpdatedVulnerability() throws Exception {
        String cveId = "CVE-2023-1234";
        VulnerabilityImpactRequest updateRequest = new VulnerabilityImpactRequest(8.5, "High impact on production");

        VulnerabilityResponse updatedResponse = new VulnerabilityResponse(
                cveId,
                VulnerabilitySeverity.HIGH,
                7.5,
                "SQL Injection vulnerability",
                Set.of("CWE-89"),
                8.5,
                "High impact on production");

        when(vulnerabilityService.updateVulnerabilityImpact(eq(cveId), any(VulnerabilityImpactRequest.class)))
                .thenReturn(updatedResponse);

        mockMvc.perform(put("/api/vulnerabilities/{cveId}/impact", cveId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(updateRequest)))
                .andExpect(status().isOk())
                .andExpect(content().contentTypeCompatibleWith(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.cveId").value(cveId))
                .andExpect(jsonPath("$.impactScore").value(8.5))
                .andExpect(jsonPath("$.impactDescription").value("High impact on production"));

        verify(vulnerabilityService, times(1))
                .updateVulnerabilityImpact(eq(cveId), any(VulnerabilityImpactRequest.class));
    }

    @Test
    public void updateVulnerability_withNullImpactScore_returnsBadRequest() throws Exception {
        String cveId = "CVE-2023-5678";
        VulnerabilityImpactRequest updateRequest = new VulnerabilityImpactRequest(null, "Some description");

        mockMvc.perform(put("/api/vulnerabilities/{cveId}/impact", cveId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(updateRequest)))
                .andExpect(status().isBadRequest());

        verify(vulnerabilityService, never()).updateVulnerabilityImpact(any(), any());
    }

    @Test
    public void updateVulnerability_withInvalidImpactScoreTooLow_returnsBadRequest() throws Exception {
        String cveId = "CVE-2023-1234";
        VulnerabilityImpactRequest updateRequest = new VulnerabilityImpactRequest(-1.0, "Invalid score");

        mockMvc.perform(put("/api/vulnerabilities/{cveId}/impact", cveId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(updateRequest)))
                .andExpect(status().isBadRequest());

        verify(vulnerabilityService, never()).updateVulnerabilityImpact(any(), any());
    }

    @Test
    public void updateVulnerability_withInvalidImpactScoreTooHigh_returnsBadRequest() throws Exception {
        String cveId = "CVE-2023-1234";
        VulnerabilityImpactRequest updateRequest = new VulnerabilityImpactRequest(11.0, "Invalid score");

        mockMvc.perform(put("/api/vulnerabilities/{cveId}/impact", cveId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(updateRequest)))
                .andExpect(status().isBadRequest());

        verify(vulnerabilityService, never()).updateVulnerabilityImpact(any(), any());
    }

    @Test
    public void updateVulnerability_withMissingRequestBody_returnsBadRequest() throws Exception {
        String cveId = "CVE-2023-1234";

        mockMvc.perform(put("/api/vulnerabilities/{cveId}/impact", cveId).contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isBadRequest());

        verify(vulnerabilityService, never()).updateVulnerabilityImpact(any(), any());
    }

    @Test
    public void updateVulnerability_notFound_returnsBadRequest() throws Exception {
        String cveId = "CVE-NOT-EXIST";
        VulnerabilityImpactRequest updateRequest = new VulnerabilityImpactRequest(5.0, "Some impact");

        doThrow(new VulnerabilityNotFoundException("Not found"))
                .when(vulnerabilityService)
                .updateVulnerabilityImpact(eq(cveId), any());

        mockMvc.perform(put("/api/vulnerabilities/{cveId}/impact", cveId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsString(updateRequest)))
                .andExpect(status().isNotFound());
    }

    @Test
    public void deleteVulnerabilityImpact_returnsNoContent() throws Exception {
        String cveId = "CVE-2023-DELETE";

        doNothing().when(vulnerabilityService).deleteVulnerabilityImpact(cveId);

        mockMvc.perform(delete("/api/vulnerabilities/{cveId}/impact", cveId)).andExpect(status().isNoContent());

        verify(vulnerabilityService, times(1)).deleteVulnerabilityImpact(cveId);
    }

    @Test
    public void deleteVulnerabilityImpact_notFound_returnsBadRequest() throws Exception {
        String cveId = "CVE-UNKNOWN";

        doThrow(new VulnerabilityNotFoundException("Not found"))
                .when(vulnerabilityService)
                .deleteVulnerabilityImpact(cveId);

        mockMvc.perform(delete("/api/vulnerabilities/{cveId}/impact", cveId)).andExpect(status().isNotFound());
    }
}
